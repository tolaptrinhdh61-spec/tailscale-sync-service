name: Smart Data Sync with Tailscale

on:
  workflow_dispatch:
    inputs:
      runner_id:
        description: "Runner ID (optional, auto-generated if empty)"
        required: false
        default: ""

env:
  DATA_DIR: "./.data-runner"
  SYNC_PORT: 22

jobs:
  smart-runner:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Runner ID
        id: runner-id
        run: |
          if [ -n "${{ github.event.inputs.runner_id }}" ]; then
            RUNNER_ID="${{ github.event.inputs.runner_id }}"
          else
            RUNNER_ID="runner-$(date +%s)-$RANDOM"
          fi
          echo "id=$RUNNER_ID" >> $GITHUB_OUTPUT
          echo "๐ Runner ID: $RUNNER_ID"

      - name: Get Tailscale OAuth Token
        id: ts-oauth
        env:
          TS_CLIENT_ID: ${{ secrets.TAILSCALE_CLIENT_ID }}
          TS_CLIENT_SECRET: ${{ secrets.TAILSCALE_CLIENT_SECRET }}
        run: |
          echo "๐ Getting OAuth access token..."

          RESPONSE=$(curl -s -f -d "client_id=${TS_CLIENT_ID}" \
            -d "client_secret=${TS_CLIENT_SECRET}" \
            https://api.tailscale.com/api/v2/oauth/token)

          if [ $? -ne 0 ]; then
            echo "โ Failed to get OAuth token"
            exit 1
          fi

          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')

          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "โ Invalid access token received"
            exit 1
          fi

          echo "token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT
          echo "โ OAuth token acquired successfully"

      - name: Create Tailscale Auth Key
        id: ts-authkey
        env:
          ACCESS_TOKEN: ${{ steps.ts-oauth.outputs.token }}
        run: |
          echo "๐ Creating reusable and ephemeral auth key..."

          # Create auth key with API (using '-' as tailnet - auto-detect from token)
          RESPONSE=$(curl -s -f -X POST \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "capabilities": {
                "devices": {
                  "create": {
                    "reusable": true,
                    "ephemeral": true,
                    "preauthorized": true
                  }
                }
              },
              "expirySeconds": 3600,
              "description": "GitHub Actions Runner - Auto-generated"
            }' \
            "https://api.tailscale.com/api/v2/tailnet/-/keys")

          if [ $? -ne 0 ]; then
            echo "โ Failed to create auth key"
            echo "Response: $RESPONSE"
            exit 1
          fi

          AUTH_KEY=$(echo "$RESPONSE" | jq -r '.key')

          if [ -z "$AUTH_KEY" ] || [ "$AUTH_KEY" = "null" ]; then
            echo "โ Invalid auth key received"
            echo "Response: $RESPONSE"
            exit 1
          fi

          echo "authkey=$AUTH_KEY" >> $GITHUB_OUTPUT
          echo "โ Auth key created (reusable, ephemeral, 1 hour expiry)"

      - name: Setup Tailscale
        env:
          AUTH_KEY: ${{ steps.ts-authkey.outputs.authkey }}
          RUNNER_ID: ${{ steps.runner-id.outputs.id }}
        run: |
          echo "๐ฆ Installing Tailscale..."
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update -qq
          sudo apt-get install -y tailscale jq curl rsync sshpass openssh-server netcat-openbsd

          echo "๐ Connecting to Tailscale network..."
          sudo tailscale up \
            --authkey="${AUTH_KEY}" \
            --hostname="gh-${RUNNER_ID}" \
            --accept-routes

          sleep 5

          TS_IP=$(tailscale ip -4)
          TS_HOSTNAME=$(tailscale status --self | awk '{print $2}')

          echo "ip=$TS_IP" >> $GITHUB_OUTPUT
          echo "hostname=$TS_HOSTNAME" >> $GITHUB_OUTPUT
          echo "โ Connected - Hostname: $TS_HOSTNAME, IP: $TS_IP"
        id: tailscale

      - name: Setup SSH Server
        env:
          RUNNER_ID: ${{ steps.runner-id.outputs.id }}
        run: |
          echo "๐ง Configuring SSH server..."

          # Set password for runner user
          SSH_PASS="sync-pass-${RUNNER_ID}"
          echo "runner:${SSH_PASS}" | sudo chpasswd

          # Configure SSH
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

          # Wait for SSH to be ready
          for i in {1..10}; do
            if sudo netstat -tlnp | grep -q ':22'; then
              echo "โ SSH server is ready on port ${{ env.SYNC_PORT }}"
              break
            fi
            sleep 1
          done

          echo "ssh_pass=$SSH_PASS" >> $GITHUB_OUTPUT
        id: ssh-setup

      - name: Discover Active Runners
        id: discover
        env:
          ACCESS_TOKEN: ${{ steps.ts-oauth.outputs.token }}
        run: |
          echo "๐ Discovering active runners in Tailscale network..."

          # Get list of all online peers (excluding self)
          SELF_HOSTNAME=$(tailscale status --self | awk '{print $2}')
          echo "Self hostname: $SELF_HOSTNAME"

          # Find active runners starting with 'gh-runner' (exclude self and offline nodes)
          ACTIVE_RUNNERS=$(sudo tailscale status --peers | grep '^[0-9]' | grep 'gh-runner' | grep -v 'offline' | grep -v "$SELF_HOSTNAME" | awk '{print $1}' || echo "")

          if [ -z "$ACTIVE_RUNNERS" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            echo "๐ญ No active runners found in network"
          else
            # Get first active runner
            ACTIVE_IP=$(echo "$ACTIVE_RUNNERS" | head -1)
            ACTIVE_HOSTNAME=$(sudo tailscale status | grep "$ACTIVE_IP" | awk '{print $2}')
            
            echo "found=true" >> $GITHUB_OUTPUT
            echo "ip=$ACTIVE_IP" >> $GITHUB_OUTPUT
            echo "hostname=$ACTIVE_HOSTNAME" >> $GITHUB_OUTPUT
            
            echo "โ Found active runner:"
            echo "   Hostname: $ACTIVE_HOSTNAME"
            echo "   IP: $ACTIVE_IP"
            
            # Extract runner ID from hostname (gh-runner-XXXXX)
            REMOTE_RUNNER_ID=$(echo "$ACTIVE_HOSTNAME" | sed 's/gh-//')
            echo "remote_runner_id=$REMOTE_RUNNER_ID" >> $GITHUB_OUTPUT
          fi

      - name: Sync Data FROM Active Runner
        if: steps.discover.outputs.found == 'true'
        env:
          ACTIVE_IP: ${{ steps.discover.outputs.ip }}
          ACTIVE_HOSTNAME: ${{ steps.discover.outputs.hostname }}
          REMOTE_RUNNER_ID: ${{ steps.discover.outputs.remote_runner_id }}
          RUNNER_ID: ${{ steps.runner-id.outputs.id }}
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ SYNCING DATA FROM ACTIVE RUNNER"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "Source: $ACTIVE_HOSTNAME ($ACTIVE_IP)"
          echo "Target: gh-$RUNNER_ID ($(tailscale ip -4))"
          echo ""

          # Create data directory
          mkdir -p ${{ env.DATA_DIR }}

          # Get remote SSH password (assuming same pattern)
          REMOTE_PASS="sync-pass-${REMOTE_RUNNER_ID}"

          # Wait for SSH to be available
          echo "โณ Waiting for SSH on $ACTIVE_IP:${{ env.SYNC_PORT }}..."
          SSH_READY=false
          for i in {1..30}; do
            if nc -zv -w 5 $ACTIVE_IP ${{ env.SYNC_PORT }} 2>&1 | grep -q succeeded; then
              echo "โ SSH is ready (attempt $i)"
              SSH_READY=true
              break
            fi
            if [ $i -eq 30 ]; then
              echo "โ SSH not available after 30 attempts"
            else
              echo "โณ Attempt $i/30 - waiting..."
              sleep 2
            fi
          done

          if [ "$SSH_READY" = false ]; then
            echo "โ๏ธ Cannot connect to SSH, skipping sync"
            echo "synced=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Perform rsync with detailed logging
          echo ""
          echo "๐ Starting rsync transfer..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

          RSYNC_LOG="/tmp/rsync-sync.log"
          RSYNC_STATS="/tmp/rsync-stats.txt"

          if sshpass -p "$REMOTE_PASS" rsync -avz --stats --timeout=60 \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10" \
            runner@$ACTIVE_IP:${{ env.DATA_DIR }}/ \
            ${{ env.DATA_DIR }}/ 2>&1 | tee "$RSYNC_LOG"; then
            
            echo ""
            echo "โ Rsync completed successfully"
            
            # Extract stats from rsync output
            grep -A 20 "Number of files" "$RSYNC_LOG" > "$RSYNC_STATS" || true
            
            # Count synced files and calculate size
            SYNCED_FILES=$(find ${{ env.DATA_DIR }} -type f | wc -l)
            SYNCED_SIZE=$(du -sh ${{ env.DATA_DIR }} 2>/dev/null | awk '{print $1}')
            SYNCED_BYTES=$(du -sb ${{ env.DATA_DIR }} 2>/dev/null | awk '{print $1}')
            
            # Get file types breakdown
            echo ""
            echo "๐ Sync Statistics:"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "   Total files synced: $SYNCED_FILES"
            echo "   Total size: $SYNCED_SIZE ($SYNCED_BYTES bytes)"
            echo "   Source runner: $ACTIVE_HOSTNAME"
            echo "   Source IP: $ACTIVE_IP"
            
            # Show detailed rsync stats
            if [ -f "$RSYNC_STATS" ]; then
              echo ""
              echo "   Rsync details:"
              cat "$RSYNC_STATS" | sed 's/^/   /'
            fi
            
            echo ""
            echo "๐ File breakdown by type:"
            echo "   JSON files: $(find ${{ env.DATA_DIR }} -name "*.json" | wc -l)"
            echo "   Text files: $(find ${{ env.DATA_DIR }} -name "*.txt" | wc -l)"
            echo "   Binary files: $(find ${{ env.DATA_DIR }} -name "*.dat" | wc -l)"
            echo "   Other files: $(find ${{ env.DATA_DIR }} -type f ! -name "*.json" ! -name "*.txt" ! -name "*.dat" | wc -l)"
            
            # Save outputs
            echo "synced=true" >> $GITHUB_OUTPUT
            echo "files=$SYNCED_FILES" >> $GITHUB_OUTPUT
            echo "size=$SYNCED_SIZE" >> $GITHUB_OUTPUT
            echo "bytes=$SYNCED_BYTES" >> $GITHUB_OUTPUT
            
            # Show synced files list
            echo ""
            echo "๐ Synced files list:"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            ls -lah ${{ env.DATA_DIR }}/ | tail -n +4 | head -20
            if [ $SYNCED_FILES -gt 20 ]; then
              echo "   ... and $((SYNCED_FILES - 20)) more files"
            fi
            
          else
            echo ""
            echo "โ Rsync failed"
            cat "$RSYNC_LOG" | tail -20
            echo "synced=false" >> $GITHUB_OUTPUT
          fi

          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        id: sync-from

      - name: Remove Active Runner from Network
        if: steps.discover.outputs.found == 'true' && steps.sync-from.outputs.synced == 'true'
        env:
          ACCESS_TOKEN: ${{ steps.ts-oauth.outputs.token }}
          ACTIVE_HOSTNAME: ${{ steps.discover.outputs.hostname }}
        run: |
          echo ""
          echo "๐ด Removing active runner from Tailscale network..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

          # Get device ID by hostname (using '-' as tailnet)
          DEVICES_RESPONSE=$(curl -s -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            "https://api.tailscale.com/api/v2/tailnet/-/devices")

          DEVICE_ID=$(echo "$DEVICES_RESPONSE" | jq -r ".devices[] | select(.hostname == \"$ACTIVE_HOSTNAME\") | .id")

          if [ -n "$DEVICE_ID" ] && [ "$DEVICE_ID" != "null" ]; then
            echo "๐ฏ Found device ID: $DEVICE_ID"
            echo "   Hostname: $ACTIVE_HOSTNAME"
            
            # Delete device via API
            DELETE_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X DELETE \
              -H "Authorization: Bearer ${ACCESS_TOKEN}" \
              "https://api.tailscale.com/api/v2/device/${DEVICE_ID}")
            
            HTTP_CODE=$(echo "$DELETE_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
              echo "โ Successfully removed $ACTIVE_HOSTNAME from network"
              echo "   Device will be automatically cleaned up (ephemeral mode)"
            else
              echo "โ๏ธ Failed to remove device (HTTP $HTTP_CODE)"
              echo "Response: $(echo "$DELETE_RESPONSE" | grep -v "HTTP_CODE:")"
            fi
          else
            echo "โ๏ธ Could not find device ID for hostname: $ACTIVE_HOSTNAME"
            echo "Available devices:"
            echo "$DEVICES_RESPONSE" | jq -r '.devices[] | "  - \(.hostname) (\(.id))"' | head -10
          fi

          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: Initialize or Update Local Data
        env:
          RUNNER_ID: ${{ steps.runner-id.outputs.id }}
        run: |
          echo ""
          echo "๐ Initializing/Updating local data..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

          mkdir -p ${{ env.DATA_DIR }}

          # Create comprehensive runner info file
          cat > ${{ env.DATA_DIR }}/runner-$RUNNER_ID.json << EOF
          {
            "runner_id": "$RUNNER_ID",
            "hostname": "${{ steps.tailscale.outputs.hostname }}",
            "ip": "${{ steps.tailscale.outputs.ip }}",
            "timestamp": "$(date -Iseconds)",
            "timestamp_unix": $(date +%s),
            "github_run_id": "${{ github.run_id }}",
            "github_run_number": "${{ github.run_number }}",
            "github_workflow": "${{ github.workflow }}",
            "github_actor": "${{ github.actor }}",
            "sync_info": {
              "synced_from_hostname": "${{ steps.discover.outputs.hostname }}",
              "synced_from_ip": "${{ steps.discover.outputs.ip }}",
              "sync_success": ${{ steps.sync-from.outputs.synced == 'true' }},
              "files_count": ${{ steps.sync-from.outputs.files || 0 }},
              "data_size": "${{ steps.sync-from.outputs.size }}",
              "data_bytes": ${{ steps.sync-from.outputs.bytes || 0 }}
            }
          }
          EOF

          # Create sample data files with runner ID
          echo "Sample data from runner: $RUNNER_ID" > ${{ env.DATA_DIR }}/data-$RUNNER_ID.txt
          echo "Created at: $(date)" >> ${{ env.DATA_DIR }}/data-$RUNNER_ID.txt
          echo "Run #${{ github.run_number }}" >> ${{ env.DATA_DIR }}/data-$RUNNER_ID.txt
          echo "Timestamp: $(date +%s)" >> ${{ env.DATA_DIR }}/data-$RUNNER_ID.txt

          # Update run history
          echo "Run #${{ github.run_number }} by $RUNNER_ID at $(date +%s)" >> ${{ env.DATA_DIR }}/run-history.txt

          # Create a binary test file with runner ID
          dd if=/dev/urandom of=${{ env.DATA_DIR }}/binary-$RUNNER_ID.dat bs=1K count=100 2>/dev/null

          # Create checksum file for verification
          cd ${{ env.DATA_DIR }}
          md5sum *.dat > checksums-$RUNNER_ID.md5 2>/dev/null || true
          cd -

          echo "โ Local data initialized for runner: $RUNNER_ID"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: Show Current Data State
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ           ๐ CURRENT DATA STATE REPORT                โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "๐ Runner Information:"
          echo "   ID: ${{ steps.runner-id.outputs.id }}"
          echo "   Hostname: ${{ steps.tailscale.outputs.hostname }}"
          echo "   IP: ${{ steps.tailscale.outputs.ip }}"
          echo "   Run: #${{ github.run_number }}"
          echo ""

          if [ "${{ steps.discover.outputs.found }}" = "true" ]; then
            echo "๐ฅ Sync Status: DATA SYNCED"
            echo "   Source: ${{ steps.discover.outputs.hostname }}"
            echo "   Source IP: ${{ steps.discover.outputs.ip }}"
            if [ "${{ steps.sync-from.outputs.synced }}" = "true" ]; then
              echo "   โ Files synced: ${{ steps.sync-from.outputs.files }}"
              echo "   โ Data size: ${{ steps.sync-from.outputs.size }}"
              echo "   โ Bytes: ${{ steps.sync-from.outputs.bytes }}"
            else
              echo "   โ๏ธ Sync failed or incomplete"
            fi
          else
            echo "๐ญ Sync Status: NO PREVIOUS RUNNER"
            echo "   Started with fresh data"
          fi

          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Data Directory Contents (${{ env.DATA_DIR }})"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ls -lah ${{ env.DATA_DIR }}/ | tail -n +4

          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Runner Info Files"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          for f in ${{ env.DATA_DIR }}/runner-*.json; do
            if [ -f "$f" ]; then
              echo ""
              echo "๐ File: $(basename $f)"
              cat "$f" | jq '.' 2>/dev/null || cat "$f"
            fi
          done

          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Data Statistics"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "Total files: $(find ${{ env.DATA_DIR }} -type f | wc -l)"
          echo "Total size: $(du -sh ${{ env.DATA_DIR }} | awk '{print $1}')"
          echo "Total bytes: $(du -sb ${{ env.DATA_DIR }} | awk '{print $1}')"
          echo "Runner info files: $(ls ${{ env.DATA_DIR }}/runner-*.json 2>/dev/null | wc -l)"
          echo "Data files: $(ls ${{ env.DATA_DIR }}/data-*.txt 2>/dev/null | wc -l)"
          echo "Binary files: $(ls ${{ env.DATA_DIR }}/binary-*.dat 2>/dev/null | wc -l)"

          if [ -f "${{ env.DATA_DIR }}/run-history.txt" ]; then
            echo ""
            echo "๐ Run History (last 10):"
            tail -10 ${{ env.DATA_DIR }}/run-history.txt | sed 's/^/   /'
          fi

          echo ""

      - name: Keep Runner Alive
        env:
          RUNNER_ID: ${{ steps.runner-id.outputs.id }}
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โฐ KEEPING RUNNER ALIVE"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "Duration: 10 minutes"
          echo "Purpose: Allow other runners to discover and sync from this runner"
          echo ""
          echo "๐ก Current Network Status:"
          echo "   Hostname: ${{ steps.tailscale.outputs.hostname }}"
          echo "   IP: ${{ steps.tailscale.outputs.ip }}"
          echo "   SSH Port: ${{ env.SYNC_PORT }}"
          echo "   SSH Password: ${{ steps.ssh-setup.outputs.ssh_pass }}"
          echo ""
          echo "Monitoring connections..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

          START=$(date +%s)

          for i in {1..120}; do
            ELAPSED=$(( $(date +%s) - START ))
            
            if [ $((i % 12)) -eq 0 ]; then
              MINUTES=$((ELAPSED / 60))
              SECONDS=$((ELAPSED % 60))
              echo ""
              echo "โฑ๏ธ  [$MINUTES:$(printf "%02d" $SECONDS)] Status check..."
              
              # Show active SSH connections
              CONNECTIONS=$(sudo netstat -tn | grep ':${{ env.SYNC_PORT }}' | grep ESTABLISHED | wc -l)
              if [ $CONNECTIONS -gt 0 ]; then
                echo "   ๐ Active SSH connections: $CONNECTIONS"
                sudo netstat -tn | grep ':${{ env.SYNC_PORT }}' | grep ESTABLISHED | awk '{print "      - " $5}' | head -5
              else
                echo "   ๐ก Listening for connections..."
              fi
              
              # Show Tailscale peers
              PEERS=$(sudo tailscale status --peers | grep -v 'offline' | wc -l)
              echo "   ๐ฅ Active peers in network: $PEERS"
              
              if [ $PEERS -gt 0 ]; then
                echo "   Peers:"
                sudo tailscale status --peers | grep -v 'offline' | head -5 | awk '{print "      - " $2 " (" $1 ")"}'
              fi
              
              # Update data directory size
              CURRENT_SIZE=$(du -sh ${{ env.DATA_DIR }} | awk '{print $1}')
              echo "   ๐พ Data directory size: $CURRENT_SIZE"
            fi
            
            sleep 5
          done

          echo ""
          echo "โฐ Keepalive period completed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: Final Summary
        if: always()
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ              โ WORKFLOW FINAL SUMMARY                 โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "๐ Runner Information:"
          echo "   ID: ${{ steps.runner-id.outputs.id }}"
          echo "   Hostname: ${{ steps.tailscale.outputs.hostname }}"
          echo "   IP: ${{ steps.tailscale.outputs.ip }}"
          echo "   GitHub Run: #${{ github.run_number }} (ID: ${{ github.run_id }})"
          echo ""

          if [ "${{ steps.discover.outputs.found }}" = "true" ]; then
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ Previous Runner Found and Processed"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "   Remote Hostname: ${{ steps.discover.outputs.hostname }}"
            echo "   Remote IP: ${{ steps.discover.outputs.ip }}"
            echo "   Remote Runner ID: ${{ steps.discover.outputs.remote_runner_id }}"
            echo ""
            if [ "${{ steps.sync-from.outputs.synced }}" = "true" ]; then
              echo "   โ Data Sync: SUCCESSFUL"
              echo "      Files transferred: ${{ steps.sync-from.outputs.files }}"
              echo "      Data size: ${{ steps.sync-from.outputs.size }}"
              echo "      Bytes: ${{ steps.sync-from.outputs.bytes }}"
            else
              echo "   โ๏ธ Data Sync: FAILED"
            fi
            echo "   ๐ด Remote runner removed from network"
          else
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ญ No Previous Runner Found"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "   This is the first runner or all previous runners are offline"
            echo "   Started with fresh data initialization"
          fi

          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Final Data State"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          FINAL_FILES=$(find ${{ env.DATA_DIR }} -type f 2>/dev/null | wc -l)
          FINAL_SIZE=$(du -sh ${{ env.DATA_DIR }} 2>/dev/null | awk '{print $1}')
          FINAL_BYTES=$(du -sb ${{ env.DATA_DIR }} 2>/dev/null | awk '{print $1}')

          echo "   Total files: $FINAL_FILES"
          echo "   Total size: $FINAL_SIZE"
          echo "   Total bytes: $FINAL_BYTES"
          echo ""
          echo "   File breakdown:"
          echo "      Runner info (JSON): $(find ${{ env.DATA_DIR }} -name "runner-*.json" 2>/dev/null | wc -l)"
          echo "      Data files (TXT): $(find ${{ env.DATA_DIR }} -name "data-*.txt" 2>/dev/null | wc -l)"
          echo "      Binary files (DAT): $(find ${{ env.DATA_DIR }} -name "binary-*.dat" 2>/dev/null | wc -l)"
          echo "      Checksum files: $(find ${{ env.DATA_DIR }} -name "*.md5" 2>/dev/null | wc -l)"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฏ Key Achievements"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "   โ Tailscale connection established"
          echo "   โ OAuth authentication successful"
          echo "   โ Ephemeral auth key created and used"
          if [ "${{ steps.discover.outputs.found }}" = "true" ]; then
            echo "   โ Active runner discovered"
            if [ "${{ steps.sync-from.outputs.synced }}" = "true" ]; then
              echo "   โ Data synced successfully"
              echo "   โ Remote runner removed from network"
            fi
          fi
          echo "   โ Local data initialized/updated"
          echo "   โ Runner kept alive for peer connections"
          echo "   โ SSH server operational"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ           ๐ WORKFLOW COMPLETED SUCCESSFULLY           โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""

      - name: Cleanup Tailscale
        if: always()
        run: |
          echo "๐งน Cleaning up Tailscale connection..."
          sudo tailscale down || true
          echo "โ Cleanup completed - ephemeral device will auto-remove"
