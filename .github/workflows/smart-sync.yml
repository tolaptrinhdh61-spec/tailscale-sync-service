name: Smart Data Sync with Tailscale (Pre-auth Key)

on:
  workflow_dispatch:
    inputs:
      runner_id:
        description: "Runner ID (optional, auto-generated if empty)"
        required: false
        default: ""

env:
  DATA_DIR: "./.data-runner"
  SYNC_PORT: 22

jobs:
  smart-runner:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Runner ID
        id: runner-id
        run: |
          if [ -n "${{ github.event.inputs.runner_id }}" ]; then
            RUNNER_ID="${{ github.event.inputs.runner_id }}"
          else
            RUNNER_ID="runner-$(date +%s)-$RANDOM"
          fi
          echo "id=$RUNNER_ID" >> $GITHUB_OUTPUT
          echo "ğŸ†” Runner ID: $RUNNER_ID"

      # ============================================================
      # OPTION 1: Use pre-generated auth key (simpler approach)
      # ============================================================
      - name: Setup Tailscale with Pre-auth Key
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
          RUNNER_ID: ${{ steps.runner-id.outputs.id }}
        run: |
          echo "ğŸ“¦ Installing Tailscale..."
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update -qq
          sudo apt-get install -y tailscale jq curl rsync sshpass openssh-server netcat-openbsd

          echo "ğŸ”Œ Connecting to Tailscale network..."
          sudo tailscale up \
            --authkey="${TAILSCALE_AUTH_KEY}" \
            --hostname="gh-${RUNNER_ID}" \
            --accept-routes

          sleep 5

          TS_IP=$(tailscale ip -4)
          TS_HOSTNAME=$(tailscale status --self | awk '{print $2}')

          echo "ip=$TS_IP" >> $GITHUB_OUTPUT
          echo "hostname=$TS_HOSTNAME" >> $GITHUB_OUTPUT
          echo "âœ… Connected - Hostname: $TS_HOSTNAME, IP: $TS_IP"
        id: tailscale

      # ============================================================
      # ğŸ” GET TAILSCALE OAUTH TOKEN (for device management only)
      # ============================================================
      - name: Get Tailscale OAuth Token
        id: ts-oauth
        env:
          TS_CLIENT_ID: ${{ secrets.TAILSCALE_CLIENT_ID }}
          TS_CLIENT_SECRET: ${{ secrets.TAILSCALE_CLIENT_SECRET }}
        run: |
          set -euo pipefail

          echo "ğŸ” Getting OAuth access token for device management..."

          # Only need devices scope for removal
          SCOPE="devices:read devices:write"

          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "https://api.tailscale.com/api/v2/oauth/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "client_id=${TS_CLIENT_ID}" \
            --data-urlencode "client_secret=${TS_CLIENT_SECRET}" \
            --data-urlencode "grant_type=client_credentials" \
            --data-urlencode "scope=${SCOPE}")

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE:")

          echo "HTTP Status Code: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ]; then
            echo "âš ï¸ OAuth token request failed (HTTP $HTTP_CODE), device removal may not work"
            echo "Response: $BODY"
            echo "token=" >> $GITHUB_OUTPUT
          else
            ACCESS_TOKEN=$(echo "$BODY" | jq -r '.access_token')
            echo "token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT
            echo "âœ… OAuth token acquired for device management"
          fi

      - name: Setup SSH Server
        env:
          RUNNER_ID: ${{ steps.runner-id.outputs.id }}
        run: |
          echo "ğŸ”§ Configuring SSH server..."

          # Set password for runner user
          SSH_PASS="sync-pass-${RUNNER_ID}"
          echo "runner:${SSH_PASS}" | sudo chpasswd

          # Configure SSH
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

          # Wait for SSH to be ready
          for i in {1..10}; do
            if sudo netstat -tlnp | grep -q ':22'; then
              echo "âœ… SSH server is ready on port ${{ env.SYNC_PORT }}"
              break
            fi
            sleep 1
          done

          echo "ssh_pass=$SSH_PASS" >> $GITHUB_OUTPUT
        id: ssh-setup

      - name: Discover Active Runners
        id: discover
        run: |
          echo "ğŸ” Discovering active runners in Tailscale network..."

          # Get list of all online peers (excluding self)
          SELF_HOSTNAME=$(tailscale status --self | awk '{print $2}')
          echo "Self hostname: $SELF_HOSTNAME"

          # Find active runners starting with 'gh-runner' (exclude self and offline nodes)
          ACTIVE_RUNNERS=$(sudo tailscale status --peers | grep '^[0-9]' | grep 'gh-runner' | grep -v 'offline' | grep -v "$SELF_HOSTNAME" | awk '{print $1}' || echo "")

          if [ -z "$ACTIVE_RUNNERS" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            echo "ğŸ”­ No active runners found in network"
          else
            # Get first active runner
            ACTIVE_IP=$(echo "$ACTIVE_RUNNERS" | head -1)
            ACTIVE_HOSTNAME=$(sudo tailscale status | grep "$ACTIVE_IP" | awk '{print $2}')
            
            echo "found=true" >> $GITHUB_OUTPUT
            echo "ip=$ACTIVE_IP" >> $GITHUB_OUTPUT
            echo "hostname=$ACTIVE_HOSTNAME" >> $GITHUB_OUTPUT
            
            echo "âœ… Found active runner:"
            echo "   Hostname: $ACTIVE_HOSTNAME"
            echo "   IP: $ACTIVE_IP"
            
            # Extract runner ID from hostname (gh-runner-XXXXX)
            REMOTE_RUNNER_ID=$(echo "$ACTIVE_HOSTNAME" | sed 's/gh-//')
            echo "remote_runner_id=$REMOTE_RUNNER_ID" >> $GITHUB_OUTPUT
          fi

      - name: Sync Data FROM Active Runner
        if: steps.discover.outputs.found == 'true'
        env:
          ACTIVE_IP: ${{ steps.discover.outputs.ip }}
          ACTIVE_HOSTNAME: ${{ steps.discover.outputs.hostname }}
          REMOTE_RUNNER_ID: ${{ steps.discover.outputs.remote_runner_id }}
          RUNNER_ID: ${{ steps.runner-id.outputs.id }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¥ SYNCING DATA FROM ACTIVE RUNNER"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Source: $ACTIVE_HOSTNAME ($ACTIVE_IP)"
          echo "Target: gh-$RUNNER_ID ($(tailscale ip -4))"
          echo ""

          mkdir -p ${{ env.DATA_DIR }}

          REMOTE_PASS="sync-pass-${REMOTE_RUNNER_ID}"

          echo "â³ Waiting for SSH on $ACTIVE_IP:${{ env.SYNC_PORT }}..."
          SSH_READY=false
          for i in {1..30}; do
            if nc -zv -w 5 $ACTIVE_IP ${{ env.SYNC_PORT }} 2>&1 | grep -q succeeded; then
              echo "âœ… SSH is ready (attempt $i)"
              SSH_READY=true
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ SSH not available after 30 attempts"
            else
              echo "â³ Attempt $i/30 - waiting..."
              sleep 2
            fi
          done

          if [ "$SSH_READY" = false ]; then
            echo "âš ï¸ Cannot connect to SSH, skipping sync"
            echo "synced=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo ""
          echo "ğŸ“ Starting rsync transfer..."

          if sshpass -p "$REMOTE_PASS" rsync -avz --stats --timeout=60 \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10" \
            runner@$ACTIVE_IP:${{ env.DATA_DIR }}/ \
            ${{ env.DATA_DIR }}/; then
            
            SYNCED_FILES=$(find ${{ env.DATA_DIR }} -type f | wc -l)
            SYNCED_SIZE=$(du -sh ${{ env.DATA_DIR }} 2>/dev/null | awk '{print $1}')
            SYNCED_BYTES=$(du -sb ${{ env.DATA_DIR }} 2>/dev/null | awk '{print $1}')
            
            echo "âœ… Rsync completed successfully"
            echo "   Files synced: $SYNCED_FILES"
            echo "   Data size: $SYNCED_SIZE"
            
            echo "synced=true" >> $GITHUB_OUTPUT
            echo "files=$SYNCED_FILES" >> $GITHUB_OUTPUT
            echo "size=$SYNCED_SIZE" >> $GITHUB_OUTPUT
            echo "bytes=$SYNCED_BYTES" >> $GITHUB_OUTPUT
          else
            echo "âŒ Rsync failed"
            echo "synced=false" >> $GITHUB_OUTPUT
          fi
        id: sync-from

      - name: Remove Active Runner from Network
        if: steps.discover.outputs.found == 'true' && steps.sync-from.outputs.synced == 'true' && steps.ts-oauth.outputs.token != ''
        env:
          ACCESS_TOKEN: ${{ steps.ts-oauth.outputs.token }}
          ACTIVE_HOSTNAME: ${{ steps.discover.outputs.hostname }}
        run: |
          echo "ğŸ”´ Removing active runner from Tailscale network..."

          DEVICES_RESPONSE=$(curl -s -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            "https://api.tailscale.com/api/v2/tailnet/-/devices")

          DEVICE_ID=$(echo "$DEVICES_RESPONSE" | jq -r ".devices[] | select(.hostname == \"$ACTIVE_HOSTNAME\") | .id")

          if [ -n "$DEVICE_ID" ] && [ "$DEVICE_ID" != "null" ]; then
            echo "ğŸ¯ Found device ID: $DEVICE_ID"
            
            DELETE_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X DELETE \
              -H "Authorization: Bearer ${ACCESS_TOKEN}" \
              "https://api.tailscale.com/api/v2/device/${DEVICE_ID}")
            
            HTTP_CODE=$(echo "$DELETE_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
              echo "âœ… Successfully removed $ACTIVE_HOSTNAME from network"
            else
              echo "âš ï¸ Failed to remove device (HTTP $HTTP_CODE)"
            fi
          else
            echo "âš ï¸ Could not find device ID for hostname: $ACTIVE_HOSTNAME"
          fi

      - name: Initialize or Update Local Data
        env:
          RUNNER_ID: ${{ steps.runner-id.outputs.id }}
        run: |
          echo "ğŸ“ Initializing/Updating local data..."
          mkdir -p ${{ env.DATA_DIR }}

          cat > ${{ env.DATA_DIR }}/runner-$RUNNER_ID.json << EOF
          {
            "runner_id": "$RUNNER_ID",
            "hostname": "${{ steps.tailscale.outputs.hostname }}",
            "ip": "${{ steps.tailscale.outputs.ip }}",
            "timestamp": "$(date -Iseconds)",
            "github_run_id": "${{ github.run_id }}",
            "sync_info": {
              "synced_from": "${{ steps.discover.outputs.hostname }}",
              "sync_success": ${{ steps.sync-from.outputs.synced == 'true' }},
              "files_count": ${{ steps.sync-from.outputs.files || 0 }}
            }
          }
          EOF

          echo "Sample data from runner: $RUNNER_ID" > ${{ env.DATA_DIR }}/data-$RUNNER_ID.txt
          echo "âœ… Local data initialized"

      - name: Show Current Data State
        run: |
          echo ""
          echo "ğŸ“Š CURRENT DATA STATE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Runner: ${{ steps.runner-id.outputs.id }}"
          echo "IP: ${{ steps.tailscale.outputs.ip }}"
          echo ""
          ls -lah ${{ env.DATA_DIR }}/
          echo ""

      - name: Keep Runner Alive
        env:
          RUNNER_ID: ${{ steps.runner-id.outputs.id }}
        run: |
          echo "â° Keeping runner alive for 10 minutes..."
          echo "Hostname: ${{ steps.tailscale.outputs.hostname }}"
          echo "IP: ${{ steps.tailscale.outputs.ip }}"

          for i in {1..120}; do
            if [ $((i % 12)) -eq 0 ]; then
              echo "â±ï¸  Status check at $(date)"
            fi
            sleep 5
          done

      - name: Cleanup Tailscale
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up Tailscale connection..."
          sudo tailscale down || true
          echo "âœ… Cleanup completed"
